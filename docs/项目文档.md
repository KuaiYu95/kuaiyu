# 快语个人博客 - 完整项目文档

本文档整合了项目的所有文档内容，包括技术方案、UI 设计、数据库备份迁移等。

---

## 目录

1. [项目概述](#项目概述)
2. [技术方案](#技术方案)
3. [UI 设计大纲](#ui设计大纲)
4. [数据库备份与迁移指南](#数据库备份与迁移指南)
5. [需求分析与补充建议](#需求分析与补充建议)

---

## 项目概述

### 核心需求

**前台功能**

- React SSR 部署，极简暗黑风格
- 中英文国际化（next-intl），居中布局（最大宽度 800px）
- 完整页面：首页、博客、生活、归档、类别、留言
- RSS 订阅链接、埋点统计、评论系统

**后台功能**

- React CSR + Vite，MUI 组件库（size=small）
- 博客/生活记录发布流程，Markdown 编辑器
- 数据统计图表（Recharts），配置管理

**技术架构**

- 后端：Go（Gin + GORM）
- 前台：Next.js 14+ SSR
- 后台：React 18+ CSR
- 数据库：MySQL 8.0+
- 部署：Docker Compose + Nginx
- 域名：kcat.site（前台：yukuai.kcat.site，后台：admin.kcat.site）

---

## 技术方案

### 一、项目架构概览

#### 整体架构

```
┌─────────────────┐
│   Nginx (80/443) │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌───▼────┐
│ 前台  │ │ 后台   │
│ SSR   │ │ CSR    │
└───┬───┘ └───┬────┘
    │         │
    └────┬────┘
         │
    ┌────▼────┐
    │  API    │
    │ Service │
    │(Go/Java)│
    └────┬────┘
         │
    ┌────▼────┐
    │  数据库  │
    │  MySQL  │
    └─────────┘
```

#### 技术栈选型

**前台技术栈**

- 框架: Next.js 14+ (App Router) - React SSR 框架
- UI 库: Tailwind CSS - 样式框架
- 动画: Framer Motion - 动画库
- 国际化: next-intl
- Markdown 渲染: react-markdown + remark-gfm
- 状态管理: Zustand 或 React Context
- HTTP 客户端: Axios
- 图片优化: next/image + 腾讯云 COS

**后台技术栈**

- 框架: React 18+ + Vite - CSR (客户端渲染)
- UI 组件库: Material-UI (MUI) v5+ (size=small)
- 路由: React Router v6
- Markdown 编辑器: @uiw/react-md-editor
- 表单处理: React Hook Form + Zod
- 状态管理: Zustand
- HTTP 客户端: Axios
- 图表库: Recharts (数据统计可视化)

**后端 API 技术栈**

- 框架: Gin (性能好，生态丰富)
- ORM: GORM (Go 最流行的 ORM)
- 数据库: MySQL 8.0+
- 认证: JWT (使用 github.com/golang-jwt/jwt)
- 文件上传: 腾讯云 COS SDK (Go 版本)
- API 文档: Swagger (使用 swaggo/swag)
- 验证: go-playground/validator
- 日志: logrus 或 zap
- 配置管理: viper

**部署技术栈**

- 容器化: Docker + Docker Compose
- Web 服务器: Nginx
- SSL 证书: Let's Encrypt (certbot)
- 进程管理: PM2 (可选，Docker 内)

### 二、数据库设计

#### 核心数据表

**users (用户表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- username: VARCHAR(50) UNIQUE (admin 账号)
- password: VARCHAR(255) (bcrypt 加密)
- email: VARCHAR(100)
- created_at: DATETIME
- updated_at: DATETIME

**posts (博客文章表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- title: VARCHAR(200) NOT NULL
- slug: VARCHAR(200) UNIQUE (URL 友好标识)
- content: TEXT (Markdown 内容)
- excerpt: TEXT (摘要)
- cover_image: VARCHAR(500) (封面图)
- status: ENUM('draft', 'published') DEFAULT 'draft'
- view_count: INT DEFAULT 0
- author_id: INT FOREIGN KEY (users.id)
- created_at: DATETIME
- updated_at: DATETIME
- published_at: DATETIME

**life_records (生活记录表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- title: VARCHAR(200) NOT NULL
- content: TEXT (Markdown 内容)
- cover_image: VARCHAR(500)
- status: ENUM('draft', 'published') DEFAULT 'draft'
- author_id: INT FOREIGN KEY (users.id)
- created_at: DATETIME
- updated_at: DATETIME
- published_at: DATETIME

**tags (标签表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- name: VARCHAR(50) UNIQUE
- slug: VARCHAR(50) UNIQUE
- description: TEXT
- created_at: DATETIME

**post_tags (博客-标签关联表)**

- post_id: INT FOREIGN KEY (posts.id)
- tag_id: INT FOREIGN KEY (tags.id)
- PRIMARY KEY (post_id, tag_id)

**comments (评论表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- post_id: INT FOREIGN KEY (posts.id) NULL (博客评论)
- life_record_id: INT FOREIGN KEY (life_records.id) NULL (生活记录评论)
- parent_id: INT FOREIGN KEY (comments.id) NULL (回复的评论 ID，仅一级回复)
- nickname: VARCHAR(50) NOT NULL
- email: VARCHAR(100) NOT NULL
- avatar: VARCHAR(500) (头像 URL)
- website: VARCHAR(500) (个人网站)
- content: TEXT NOT NULL
- is_admin: BOOLEAN DEFAULT FALSE (是否为管理员回复)
- status: ENUM('pending', 'approved', 'spam') DEFAULT 'pending'
- ip_address: VARCHAR(45)
- user_agent: VARCHAR(500)
- created_at: DATETIME
- updated_at: DATETIME

**评论规则说明**:

- **首次评论判断**: 基于邮箱判断，如果该邮箱从未发表过 `status='approved'` 的评论，则视为首次评论
- **审核策略**: 首次评论需要审核（status='pending'），后续自动通过（status='approved'）
- **回复层级**: 所有回复只有一个层级（parent_id 指向主评论，不支持嵌套）
- **回复排序**: 回复按时间排序（最早在前）
- **回复展示**: 默认展示 3 条回复，点击"查看更多"展示全部

**site_config (网站配置表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- key: VARCHAR(100) UNIQUE NOT NULL
- value: TEXT
- type: ENUM('string', 'json', 'image') DEFAULT 'string'
- updated_at: DATETIME

**page_views (访问统计表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- page_type: ENUM('post', 'life', 'home', 'archive', 'category', 'guestbook')
- page_id: INT NULL (文章 ID，首页等为 NULL)
- ip_address: VARCHAR(45)
- user_agent: VARCHAR(500)
- referer: VARCHAR(500)
- country: VARCHAR(50)
- city: VARCHAR(50)
- device_type: ENUM('desktop', 'mobile', 'tablet')
- browser: VARCHAR(50)
- os: VARCHAR(50)
- created_at: DATETIME

**analytics_events (埋点事件表)**

- id: INT PRIMARY KEY AUTO_INCREMENT
- event_type: VARCHAR(50) (click, view, scroll, etc.)
- event_name: VARCHAR(100)
- page_type: VARCHAR(50)
- page_id: INT NULL
- user_id: VARCHAR(100) NULL (匿名用户 ID)
- properties: JSON (事件属性)
- ip_address: VARCHAR(45)
- user_agent: VARCHAR(500)
- created_at: DATETIME

### 三、API 接口设计

#### 前台 API (Public API)

**博客相关**

- `GET /api/posts` - 获取博客列表
- `GET /api/posts/:slug` - 获取博客详情
- `GET /api/posts/:id/views` - 增加阅读量

**生活记录相关**

- `GET /api/life` - 获取生活记录列表
- `GET /api/life/:id` - 获取生活记录详情

**标签相关**

- `GET /api/tags` - 获取所有标签
- `GET /api/tags/:slug` - 获取标签详情及关联博客

**归档相关**

- `GET /api/archives` - 获取归档列表（按年月，全部展示）

**评论相关**

- `GET /api/comments` - 获取评论列表
- `POST /api/comments` - 提交评论

**配置相关**

- `GET /api/config` - 获取网站配置

**RSS 相关**

- `GET /api/rss` - 获取 RSS Feed (XML 格式)

**SEO 相关**

- `GET /api/sitemap.xml` - 生成 Sitemap（XML 格式）
- `GET /api/robots.txt` - 获取 robots.txt

**埋点相关**

- `POST /api/analytics/track` - 上报埋点事件
- `POST /api/analytics/pageview` - 上报页面访问

#### 后台 API (Admin API)

**认证相关**

- `POST /api/admin/login` - 管理员登录
- `POST /api/admin/logout` - 登出
- `GET /api/admin/me` - 获取当前管理员信息

**博客管理**

- `GET /api/admin/posts` - 获取博客列表（管理）
- `GET /api/admin/posts/:id` - 获取博客详情
- `POST /api/admin/posts` - 创建博客
- `PUT /api/admin/posts/:id` - 更新博客
- `DELETE /api/admin/posts/:id` - 删除博客

**生活记录管理**

- `GET /api/admin/life` - 获取生活记录列表
- `POST /api/admin/life` - 创建生活记录
- `PUT /api/admin/life/:id` - 更新生活记录
- `DELETE /api/admin/life/:id` - 删除生活记录

**标签管理**

- `GET /api/admin/tags` - 获取标签列表
- `POST /api/admin/tags` - 创建标签
- `PUT /api/admin/tags/:id` - 更新标签
- `DELETE /api/admin/tags/:id` - 删除标签

**评论管理**

- `GET /api/admin/comments` - 获取评论列表
- `PUT /api/admin/comments/:id` - 更新评论状态
- `DELETE /api/admin/comments/:id` - 删除评论
- `POST /api/admin/comments/:id/reply` - 管理员回复评论

**配置管理**

- `GET /api/admin/config` - 获取所有配置
- `PUT /api/admin/config` - 更新配置
- `POST /api/admin/upload` - 上传文件到腾讯云

**统计分析**

- `GET /api/admin/analytics/overview` - 获取统计概览
- `GET /api/admin/analytics/visits` - 获取访问统计
- `GET /api/admin/analytics/popular` - 获取热门内容
- `GET /api/admin/analytics/events` - 获取埋点事件统计
- `GET /api/admin/analytics/charts` - 获取图表数据

#### 接口设计原则

1. **RESTful 规范**: 使用标准 HTTP 方法和状态码
2. **统一响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2024-01-01T00:00:00Z"
}
```

3. **分页格式**:

```json
{
  "items": [],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

4. **错误处理**: 统一错误码和错误信息

### 四、安全方案

#### 认证与授权

- **JWT Token**: 使用 HttpOnly Cookie 存储，防止 XSS 攻击
- **Token 过期**: Access Token 15 分钟，Refresh Token 7 天
- **密码加密**: 使用 bcrypt，salt rounds = 10
- **登录限制**: 5 次失败后锁定 15 分钟

#### 数据安全

- **SQL 注入防护**: 使用 ORM 参数化查询
- **XSS 防护**: 输入输出转义，CSP 策略
- **CSRF 防护**: 使用 CSRF Token
- **敏感信息**: 不在日志中记录密码等敏感信息

#### 接口安全

- **CORS 配置**: 严格限制允许的域名
- **Rate Limiting**:
  - 公共接口: 100 次/分钟
  - 评论提交: 5 次/分钟
  - 登录接口: 5 次/15 分钟
- **请求验证**: 验证请求来源和 User-Agent
- **IP 白名单**: 后台管理接口可配置 IP 白名单

#### 文件上传安全

- **文件类型验证**: 仅允许图片格式 (jpg, png, gif, webp)
- **文件大小限制**: 单文件最大 5MB
- **文件名处理**: 重命名为 UUID，防止路径遍历

### 五、性能优化

#### 前端优化

- **SSR/SSG**: Next.js 自动优化，静态页面预渲染
- **图片优化**: next/image 自动优化，腾讯云 COS CDN 加速，WebP 格式支持，懒加载
- **代码分割**: 路由级别代码分割
- **缓存策略**: 静态资源长期缓存，API 响应合理缓存
- **字体优化**: 使用 next/font 优化字体加载

#### 后端优化

- **数据库索引**: 合理设计索引，避免 N+1 查询
- **查询优化**: 使用 JOIN 减少查询次数，分页查询
- **缓存策略**: Redis 缓存热点数据（可选），配置信息缓存
- **连接池**: 数据库连接池配置

#### CDN 与存储

- **静态资源**: 使用 CDN 加速
- **图片存储**: 腾讯云 COS + CDN
- **文件压缩**: Gzip/Brotli 压缩

### 六、部署方案

#### Docker Compose 配置

```yaml
version: "3.8"

services:
  # 数据库
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  # 后端API (Go)
  api:
    build: ./api
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_NAME=${MYSQL_DATABASE}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - mysql
    ports:
      - "8080:8080"

  # 前台前端 (SSR)
  frontend:
    build: ./frontend
    environment:
      - NEXT_PUBLIC_API_URL=http://api:8080
    ports:
      - "3000:3000"
    depends_on:
      - api

  # 后台前端 (CSR)
  admin:
    build: ./admin
    environment:
      - VITE_API_URL=http://api:8080
    ports:
      - "5173:80"
    depends_on:
      - api

  # Nginx
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - admin
      - api

volumes:
  mysql_data:
```

#### Nginx 配置要点

- 反向代理前台、后台、API
- SSL 证书配置
- 静态资源缓存
- Gzip 压缩
- 安全头设置

### 七、开发规范

#### 代码规范

- **TypeScript**: 严格模式，类型安全
- **ESLint + Prettier**: 代码格式统一
- **Git 规范**: Conventional Commits
- **代码审查**: PR 必须经过审查

#### 目录结构

**前台项目结构**

```
frontend/
├── app/                 # Next.js App Router
│   ├── [locale]/        # 国际化路由
│   ├── api/             # API路由
│   └── layout.tsx       # 根布局
├── components/          # 组件
├── lib/                 # 工具函数
├── styles/              # 样式
└── public/              # 静态资源
```

**后台项目结构**

```
admin/
├── src/
│   ├── pages/           # 页面
│   ├── components/      # 组件
│   ├── lib/             # 工具函数
│   ├── store/           # 状态管理
│   └── App.tsx          # 根组件
└── public/              # 静态资源
```

**API 项目结构**

```
api/
├── cmd/
│   └── server/
│       └── main.go      # 入口文件
├── internal/
│   ├── handler/         # 处理器
│   ├── service/         # 业务逻辑
│   ├── repository/      # 数据访问
│   ├── model/           # 数据模型
│   ├── middleware/      # 中间件
│   └── config/          # 配置
├── pkg/                 # 公共包
└── migrations/          # 数据库迁移
```

---

## UI 设计大纲

### 一、设计理念

#### 设计风格

- **极简暗黑风格**: 深色背景，高对比度，减少视觉干扰
- **居中布局**: 所有内容居中展示，最大宽度 800px
- **丝滑动效**: 使用现代 CSS 和 JS 动画库，提升交互体验
- **字体规范**: 默认 14px，层次分明

#### 色彩方案

**主色调（暗黑主题）**

```
背景色:
- 主背景: #0a0a0a (纯黑)
- 卡片背景: #1a1a1a (深灰)
- 悬浮背景: #252525 (中灰)

文字色:
- 主文字: #e5e5e5 (浅灰)
- 次要文字: #a0a0a0 (中灰)
- 强调文字: #ffffff (纯白)
- 链接文字: #60a5fa (蓝色)

强调色:
- 主强调: #60a5fa (蓝色)
- 次要强调: #34d399 (绿色)
- 警告: #fbbf24 (黄色)
- 错误: #f87171 (红色)

边框色:
- 默认边框: #2a2a2a
- 悬浮边框: #3a3a3a
```

### 二、页面设计

#### 全局组件

**Header (导航栏)**

- 固定在顶部，滚动时背景模糊（backdrop-filter）
- Logo 在左侧，导航居中，语言切换在右侧
- 导航项 hover 时有下划线动画
- 移动端：汉堡菜单

**Footer**

- 左侧：图片+名称+描述+备案号，垂直排列
- 右侧：多个类别，每个类别下有多个链接，自适应网格布局
- 响应式：移动端垂直堆叠

#### 首页设计

**首屏区域**

- 头像：圆形，大尺寸（120px），有 hover 放大效果
- 昵称：大字体（24px），加粗
- 关于我：Markdown 渲染，居中展示
- 背景：渐变或粒子效果（可选）

**近期博客区域**

- 卡片式布局，每篇文章一个卡片
- 封面图：左侧或顶部，16:9 比例
- 卡片 hover：轻微上浮+阴影效果
- 标签：小圆点或胶囊样式，不同颜色

**近期生活区域**

- 更生活化的设计，可以使用更柔和的圆角
- 封面图可以更随意，不强制 16:9

**标签分类区域**

- 标签：胶囊样式，不同大小和颜色
- hover：放大+颜色变化
- 点击跳转到类别页面并筛选

**近期留言区域**

- 简洁的留言卡片
- 头像：圆形，小尺寸（40px）
- 网站链接：如果有，显示为图标或文字链接

#### 博客页面设计

**博客列表页**

- 按日期倒序排列
- 卡片式布局，间距合理
- 滚动加载或分页
- 空状态：友好的提示

**博客详情页**

- 标题：大字体（32px），加粗
- 封面图：全宽，16:9，有 hover 效果
- Markdown 内容：合适的行高和间距
- 代码块：主题色好看，支持复制
- 评论区域：分隔线，清晰区分

#### 生活页面设计

**生活列表页**

- 更生活化的设计风格
- 内容如果少于 500 字，全部展示
- 内容如果多于 500 字，展示前 300 字+查看更多
- 点击查看更多：展开全文（平滑动画）
- 不需要详情页，所有内容在列表页展示

#### 归档页面设计

- 按年份分组
- 年份：大字体，加粗
- 文章列表：简洁，仅显示标题
- 点击标题跳转到详情页
- 全部展示，不支持按年份筛选

#### 类别页面设计

**标签列表**

- 标签云展示
- 标签统计: 显示每个标签的文章数量

**标签筛选结果**

- 类似博客列表页
- 显示当前筛选的标签

#### 留言页面设计

- 留言列表在上，表单在下
- 回复：所有回复一个层级，按时间排序
- 默认展示 3 条回复，点击"查看更多"展示全部
- 管理员回复：特殊样式标识
- 表单：清晰的必填标识
- 头像上传：预览功能
- 本地存储：填写后保存到 localStorage

#### 评论组件设计

**评论组件结构**

- **回复层级**: 所有回复只有一个层级（parent_id 指向主评论）
- **排序规则**: 回复按时间排序（最早在前）
- **展示逻辑**:
  - 默认展示 3 条回复
  - 如果回复超过 3 条，显示"查看更多回复"按钮
  - 点击后展开全部回复
- **管理员回复**: 特殊样式标识（如背景色、图标）
- **回复表单**: 点击"回复"按钮，在对应评论下方显示回复表单
- **首次审核**: 首次评论需要审核，后续自动通过

### 三、动效设计

#### 页面滚动动效

1. **视差滚动**: 背景元素缓慢移动，文字内容正常滚动
2. **元素渐入**: 滚动到视口时，元素从下方淡入+上移，使用 Intersection Observer API
3. **滚动进度条**: 顶部显示阅读进度条，平滑动画

#### Hover 动效

1. **卡片悬浮**: 轻微上浮（translateY: -4px），阴影加深，过渡时间：0.3s ease
2. **链接悬浮**: 下划线从左侧滑入，颜色变化，使用 CSS ::after 伪元素
3. **按钮悬浮**: 背景色变化，轻微放大（scale: 1.05），阴影效果
4. **图片悬浮**: 轻微放大（scale: 1.05），过渡时间：0.3s ease

#### 页面切换动效

1. **路由切换**: 淡入淡出（fade）或滑动切换（slide）
2. **加载状态**: Skeleton 加载动画，进度条

#### 表单动效

1. **输入框聚焦**: 边框颜色变化，标签上移（Material Design 风格）
2. **提交按钮**: 加载状态：旋转动画，成功：对勾动画，失败：抖动动画

#### 评论动效

1. **新评论添加**: 从下方滑入，淡入效果
2. **回复展开**: 点击"查看更多回复"时，平滑展开全部回复，使用高度动画，过渡时间 0.3s

### 四、响应式设计

#### 断点设置

```
- Mobile: < 768px
- Tablet: 768px - 1024px
- Desktop: > 1024px
```

#### 移动端适配

1. **导航栏**: 汉堡菜单，侧边栏导航
2. **内容布局**: 单列布局，卡片全宽，字体适当放大
3. **图片**: 全宽显示，优化加载
4. **表单**: 输入框全宽，按钮全宽

### 五、国际化设计

#### 语言切换

- 位置：Header 右上角
- 样式：图标+文字（中/EN）
- 动效：切换时平滑过渡

#### 文本适配

- 中英文字体：使用合适的字体
- 长度适配：考虑不同语言文本长度
- RTL 支持：预留（如需要）

#### 日期格式

- 中文：2024 年 1 月 1 日
- 英文：January 1, 2024

### 六、后台管理 UI 设计

#### 整体风格

- 使用 MUI 模板，size=small
- 暗色主题（与前台一致）
- 创新设计，避免传统管理平台风格

#### 布局设计

```
┌─────────────────────────────────────────┐
│  [Logo]  [导航]              [用户]     │
├──────────┬──────────────────────────────┤
│          │                              │
│  侧边栏  │        内容区域               │
│          │                              │
│          │                              │
└──────────┴──────────────────────────────┘
```

#### 主要页面

**仪表盘（统计图表）**

- 数据卡片：大数字展示，有趋势箭头（↑↓）
- 图表：使用 Recharts 或 Chart.js，暗色主题
- 实时更新：WebSocket 或定时刷新
- 时间筛选：支持今天、最近 7 天、最近 30 天、自定义
- 响应式：移动端图表自适应

**博客管理**

- 列表：表格或卡片
- 编辑：Markdown 编辑器
- 上传：拖拽或点击上传

**生活记录管理**

- 类似博客管理
- 更简洁的界面

**评论管理**

- 快速操作：一键通过/拒绝，批量操作，快速回复

**统计分析页面**

- 访问统计：访问趋势图表（折线图），设备分布（饼图），浏览器分布（柱状图），地区分布（地图或列表），访问来源（来源域名统计）
- 内容统计：热门文章排行，热门标签，评论统计，阅读时长分析
- 用户行为：埋点事件统计，点击热力图（可选），用户路径分析，转化漏斗

**设置**

- 网站配置：Logo、网站名称、备案号
- 首页配置：头像、昵称、关于我
- Footer 配置：左侧图片、名称、描述，右侧链接（动态表单）

### 七、技术实现要点

#### CSS 技术

- **CSS 变量**: 统一管理颜色和尺寸
- **Grid/Flexbox**: 布局
- **Backdrop Filter**: 毛玻璃效果
- **Clip Path**: 特殊形状
- **CSS Animations**: 基础动画
- **Transitions**: 过渡效果

#### JS 动画库

- **Framer Motion**: 复杂动画
- **React Spring**: 物理动画
- **GSAP**: 高级动画（如需要）

#### 性能优化

- **Will-change**: 提示浏览器优化
- **Transform/Opacity**: 使用 GPU 加速属性
- **防抖节流**: 滚动和 resize 事件
- **懒加载**: 图片和组件

### 八、错误与空状态设计

#### 错误页面设计

**404 页面（页面不存在）**

- 暗黑风格，居中布局
- 友好的错误提示
- 提供返回首页和返回上一页按钮
- 可添加动画效果

**500 页面（服务器错误）**

- 与 404 页面风格一致
- 提供刷新按钮
- 可显示错误 ID（用于问题追踪）

#### 加载状态设计

**Skeleton 加载（骨架屏）**

- 使用灰色矩形模拟内容
- 添加闪烁动画（shimmer 效果）
- 与实际内容布局一致

**进度条加载**

- 页面顶部显示细进度条
- 加载完成时进度条消失
- 使用 NProgress 或类似库

#### 空状态设计

**博客列表为空**

- 友好的提示文案
- 图标或插画
- 可提供建议操作

**搜索结果为空**

- 友好的提示文案
- 搜索图标
- 可提供建议操作

#### 表单验证错误提示

**设计规范**

- 错误提示显示在输入框下方
- 使用红色文字（#f87171）
- 实时验证（onBlur 或 onChange）
- 错误图标（可选）

---

## 数据库备份与迁移指南

### 一、数据库备份

#### 手动备份

**使用 mysqldump 备份**

```bash
# 备份整个数据库
mysqldump -u root -p --single-transaction --routines --triggers \
  --databases blog_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份并压缩
mysqldump -u root -p --single-transaction --routines --triggers \
  --databases blog_db | gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz
```

**备份参数说明**

- `--single-transaction`: 保证数据一致性，适用于 InnoDB
- `--routines`: 备份存储过程和函数
- `--triggers`: 备份触发器
- `--databases`: 备份整个数据库（包括创建数据库语句）

#### 自动备份脚本

**创建备份脚本**

```bash
#!/bin/bash
# backup.sh

# 配置
DB_USER="root"
DB_PASS="your_password"
DB_NAME="blog_db"
BACKUP_DIR="/backup/mysql"
RETENTION_DAYS=7  # 保留7天

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份文件名
BACKUP_FILE="backup_${DB_NAME}_$(date +%Y%m%d_%H%M%S).sql.gz"

# 执行备份
mysqldump -u $DB_USER -p$DB_PASS \
  --single-transaction \
  --routines \
  --triggers \
  --databases $DB_NAME | gzip > $BACKUP_DIR/$BACKUP_FILE

# 检查备份是否成功
if [ $? -eq 0 ]; then
  echo "备份成功: $BACKUP_FILE"
  # 删除旧备份
  find $BACKUP_DIR -name "backup_${DB_NAME}_*.sql.gz" -mtime +$RETENTION_DAYS -delete
else
  echo "备份失败!"
  exit 1
fi
```

**设置定时任务（Cron）**

```bash
# 编辑 crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh >> /var/log/backup.log 2>&1
```

#### Docker 环境备份

```bash
#!/bin/bash
# backup-docker.sh

CONTAINER_NAME="kuaiyu_mysql"
DB_NAME="kuaiyu_db"
DB_USER="root"
DB_PASS="your_password"
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 执行备份
docker exec $CONTAINER_NAME mysqldump -u $DB_USER -p$DB_PASS \
  --single-transaction \
  --routines \
  --triggers \
  --databases $DB_NAME | gzip > $BACKUP_DIR/backup_${DATE}.sql.gz

echo "备份完成: $BACKUP_DIR/backup_${DATE}.sql.gz"
```

### 二、数据库恢复

#### 从 SQL 文件恢复

```bash
# 恢复未压缩的备份
mysql -u root -p < backup_20240101_120000.sql

# 恢复压缩的备份
gunzip < backup_20240101_120000.sql.gz | mysql -u root -p

# 恢复指定数据库
mysql -u root -p blog_db < backup_20240101_120000.sql
```

#### Docker 环境恢复

```bash
# 方法1: 从文件恢复
gunzip < backup_20240101_120000.sql.gz | \
  docker exec -i kuaiyu_mysql mysql -u root -p$DB_PASS blog_db

# 方法2: 复制文件到容器后恢复
docker cp backup_20240101_120000.sql.gz kuaiyu_mysql:/tmp/
docker exec kuaiyu_mysql sh -c 'gunzip < /tmp/backup_20240101_120000.sql.gz | mysql -u root -p$DB_PASS blog_db'
```

#### 恢复前准备

1. **停止相关服务**

```bash
docker-compose stop api frontend admin
```

2. **备份当前数据（以防万一）**

```bash
mysqldump -u root -p blog_db > before_restore_$(date +%Y%m%d_%H%M%S).sql
```

3. **清空现有数据（可选）**

```bash
mysql -u root -p -e "DROP DATABASE IF EXISTS blog_db;"
mysql -u root -p -e "CREATE DATABASE blog_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

### 三、数据库迁移

#### 迁移到新服务器

**步骤 1: 在源服务器备份**

```bash
mysqldump -u root -p --single-transaction --routines --triggers \
  --databases blog_db | gzip > migration_backup_$(date +%Y%m%d).sql.gz
```

**步骤 2: 传输备份文件**

```bash
# 使用 SCP
scp migration_backup_20240101.sql.gz user@new_server:/backup/

# 使用 RSYNC
rsync -avz migration_backup_20240101.sql.gz user@new_server:/backup/
```

**步骤 3: 在新服务器恢复**

```bash
# 在新服务器上创建数据库
mysql -u root -p -e "CREATE DATABASE blog_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 恢复数据
gunzip < migration_backup_20240101.sql.gz | mysql -u root -p blog_db

# 验证数据
mysql -u root -p -e "USE blog_db; SHOW TABLES; SELECT COUNT(*) FROM posts;"
```

#### 迁移到 Docker 环境

```bash
# 1. 在源服务器备份
mysqldump -u root -p --single-transaction --routines --triggers \
  --databases blog_db > migration.sql

# 2. 启动 Docker MySQL 容器
docker-compose up -d mysql

# 3. 等待 MySQL 启动
sleep 10

# 4. 恢复数据
docker exec -i kuaiyu_mysql mysql -u root -p$MYSQL_ROOT_PASSWORD < migration.sql

# 5. 验证
docker exec kuaiyu_mysql mysql -u root -p$MYSQL_ROOT_PASSWORD -e "USE blog_db; SHOW TABLES;"
```

### 四、备份策略建议

#### 备份频率

- **生产环境**: 每天全量备份 + 每小时增量备份
- **开发环境**: 每天全量备份
- **测试环境**: 每周全量备份

#### 备份保留策略

- **本地备份**: 保留最近 7 天
- **远程备份**: 保留最近 30 天
- **月度备份**: 保留最近 12 个月
- **年度备份**: 永久保留

#### 备份验证

- 每周验证一次备份文件完整性
- 每月进行一次恢复测试
- 记录备份和恢复日志

#### 备份存储

- **本地存储**: 服务器本地磁盘
- **远程存储**: 云存储（OSS、S3 等）
- **异地备份**: 不同地区的服务器

---

## 需求分析与补充建议

### 一、项目概述

#### 核心需求

**前台功能**

- React SSR 部署，极简暗黑风格
- 中英文国际化（next-intl），居中布局（最大宽度 800px）
- 完整页面：首页、博客、生活、归档、类别、留言
- RSS 订阅链接、埋点统计、评论系统

**后台功能**

- React CSR + Vite，MUI 组件库（size=small）
- 博客/生活记录发布流程，Markdown 编辑器
- 数据统计图表（Recharts），配置管理

**技术架构**

- 后端：Go（Gin + GORM）
- 前台：Next.js 14+ SSR
- 后台：React 18+ CSR
- 数据库：MySQL 8.0+
- 部署：Docker Compose + Nginx
- 域名：kcat.site（前台：yukuai.kcat.site，后台：admin.kcat.site）

### 二、已确定的技术选型

#### 后端技术栈

- **语言**: Go
- **框架**: Gin
- **ORM**: GORM
- **认证**: JWT
- **API 文档**: Swagger (swaggo/swag)

#### 前台技术栈

- **框架**: Next.js 14+ (App Router)
- **国际化**: next-intl
- **样式**: Tailwind CSS
- **动画**: Framer Motion + React Spring
- **Markdown**: react-markdown + highlight.js
- **HTTP**: Axios

#### 后台技术栈

- **框架**: React 18+ + Vite
- **UI 库**: Material-UI (MUI) v5+ (size=small)
- **路由**: React Router v6
- **Markdown 编辑器**: @uiw/react-md-editor
- **图表库**: Recharts
- **表单**: React Hook Form + Zod
- **状态管理**: Zustand

#### 部署配置

- **域名**: kcat.site
- **前台域名**: yukuai.kcat.site
- **后台域名**: admin.kcat.site
- **SSL**: Let's Encrypt
- **服务器建议**: 2 核 4G 内存，20G 硬盘（初期足够）

### 三、已确定的功能决策

#### 订阅功能

- ✅ 仅支持 RSS 订阅链接
- ❌ 不提供邮件通知功能

#### 评论系统

- ✅ **审核策略**: 首次评论需要审核，后续自动通过
- ✅ **回复层级**: 所有回复一个层级（parent_id 指向主评论）
- ✅ **回复排序**: 按时间排序
- ✅ **回复展示**: 默认展示 3 条，点击"查看更多"展示全部
- ✅ **生活记录**: 支持评论和回复，与博客一致

#### 归档页面

- ✅ 不支持按年份筛选
- ✅ 全部展示所有文章

### 四、功能优先级规划

#### 高优先级（必须实现）

1. ✅ **基础功能**

   - 博客文章管理（发布、编辑、删除）
   - 生活记录管理
   - 评论系统（评论、回复、审核）

2. ✅ **后台管理**

   - 登录认证
   - 内容发布流程
   - 配置管理（网站信息、Footer 配置）

3. ✅ **安全防护**

   - JWT 认证
   - 数据加密
   - 接口限流
   - 安全头设置

4. ✅ **SEO 优化（完美支持）**

   - Meta 标签配置（title, description, OG, Twitter Card）
   - 结构化数据（JSON-LD）
   - Sitemap 自动生成（多语言）
   - robots.txt 配置
   - 语义化 HTML
   - URL 优化
   - 性能优化（影响 SEO）

5. ✅ **埋点统计**

   - 前端埋点 SDK
   - 访问统计（PV、UV）

6. ✅ **RSS 订阅**

   - RSS Feed 生成（XML）
   - 支持 RSS 阅读器订阅

7. ✅ **数据备份**
   - 自动备份数据库
   - 一键恢复功能

#### 中优先级（推荐实现）

1. 🔶 **搜索功能**

   - 站内搜索（前端搜索或后端全文搜索）

2. 🔶 **统计图表**

   - 后台数据可视化（访问趋势、设备分布、热门内容）

3. 🔶 **评论审核机制**

   - 垃圾评论检测
   - 敏感词过滤
   - IP 频率限制

4. 🔶 **图片管理优化**
   - 图片库管理
   - 图片压缩
   - WebP 格式支持

#### 低优先级（可选实现）

1. 🔹 **文章置顶功能**
2. 🔹 **监控告警**（Sentry、性能监控）
3. 🔹 **CI/CD**（自动化部署）
4. 🔹 **测试覆盖**（单元测试、E2E）
5. 🔹 **无障碍访问**（ARIA、键盘导航）

### 五、开发阶段规划

#### 第一阶段：基础搭建（2-3 周）

- 数据库设计与初始化
- 后端 API 开发（Go + Gin + GORM）
- 前台核心页面
- 后台基础功能
- 评论系统基础功能

#### 第二阶段：功能完善（2-3 周）

- 前台完整页面
- 后台完整功能
- SEO 优化（完美支持）
- 埋点系统
- RSS 订阅
- 图片上传

#### 第三阶段：统计与优化（1-2 周）

- 访问统计功能
- 后台统计图表
- 性能优化
- 安全加固

#### 第四阶段：部署与测试（1-2 周）

- Docker 部署配置
- Nginx 配置
- SSL 证书配置
- 数据备份方案
- 功能测试
- 部署文档编写

#### 第五阶段：增强功能（可选，1-2 周）

- 搜索功能
- 评论审核优化
- 其他增强功能

### 六、项目总结

#### 技术栈总结

- **后端**: Go (Gin + GORM)
- **前台**: Next.js 14+ SSR
- **后台**: React 18+ CSR (Vite)
- **数据库**: MySQL 8.0+
- **部署**: Docker Compose + Nginx
- **域名**: kcat.site（前台：yukuai.kcat.site，后台：admin.kcat.site）

#### 核心功能总结

- ✅ 博客文章管理
- ✅ 生活记录管理
- ✅ 评论系统（单层回复）
- ✅ RSS 订阅
- ✅ 埋点统计
- ✅ 数据可视化
- ✅ SEO 优化
- ✅ 数据备份

#### 开发周期

- **预计总时长**: 6-10 周
- **核心功能**: 4-6 周
- **优化与部署**: 2-4 周

#### 开发建议

1. **优先级**: 严格按照优先级顺序开发，先完成高优先级功能
2. **分阶段**: 分阶段开发，每个阶段都有明确的交付物
3. **安全**: 注重安全防护，从开发初期就考虑安全问题
4. **性能**: 性能优化贯穿整个开发过程
5. **文档**: 及时更新文档，保持文档与代码同步
6. **测试**: 关键功能需要测试，确保质量

---

## 部署说明

### 部署环境要求

- **服务器**: 腾讯云宝塔服务器
- **根域名**: kcat.site
- **前台域名**: yukuai.kcat.site
- **后台域名**: admin.kcat.site
- **SSL 证书**: 使用 Let's Encrypt 或腾讯云 SSL 证书

### 部署步骤

1. **准备服务器环境**

   - 安装 Docker 和 Docker Compose
   - 配置域名解析（A 记录指向服务器 IP）

2. **配置 SSL 证书**

   - 将 SSL 证书文件放置在 `nginx/ssl/` 目录
   - 证书文件：`fullchain.pem` 和 `privkey.pem`

3. **配置环境变量**

   - 复制 `env.example` 为 `.env`
   - 修改数据库密码、JWT Secret 等配置

4. **构建和推送镜像**

   - 使用 `scripts/build-and-push.sh` 脚本构建镜像
   - 推送到服务器或 Docker Registry

5. **一键部署**
   - 在服务器上运行 `docker-compose up -d`
   - 或使用 `scripts/deploy.sh` 脚本

### 注意事项

- 确保服务器防火墙开放 80 和 443 端口
- 确保域名解析正确
- SSL 证书需要定期更新（Let's Encrypt 证书有效期为 90 天）
- 定期备份数据库（使用 `scripts/backup.sh`）

---

**文档版本**: v1.0  
**最后更新**: 2024-01-01  
**维护者**: 快语团队
